<h1 id=""></h1>
<h2 id="api-security">API Security</h2>
<p>De blade template engine maakt de presentatie van data via views mogelijk. Toch kun je laravel ook uitsluitend als back-end oplossing gebruiken. De presentatie wordt dan overgelaten aan javascript frameworks zoals Vue.js of React. Deze opzet is vooral van toepassing als je een single page application wilt maken.
Laravel publiceert dan data als json-objecten aan een front-end javascript applicatie.
Het gebruik van blade en views wordt op deze manier overbodig.</p>
<h2 id="laravel-sanctum">Laravel Sanctum</h2>
<p>In Laravel 8 is Sanctum standaard al geactiveerd. Ook een aantal van de starter-kits van Laravel zoals Jetstream en Breeze zijn al voorzien van Sanctum.
Sanctum is een authenticatie systeem voor o.a. SPA's, third-party apps en mobiele applicaties. De authenticatie gebeurt op basis van tokens. Het gebruik van tokens is essentieel voor API's zodat ook andere applicaties dan webbrowsers gebruik kunnen maken van authenticatie-mechanismen. Alleen webbrowsers werken met cookies en sessie-variabelen. De meeste webapplicaties zijn hierop gebaseerd.<br>
In eerste instantie stuur je vanuit een formulier je username en password naar de API.</p>
<ul>
<li>Naam en wachtwoord worden gechecked</li>
<li>Indien alles ok....
<ul>
<li>Er wordt een token aangemaakt
Het token wordt bij ieder volgend request meegestuurd. Authenticatie vindt dan dus plaats op basis van het token.</li>
</ul>
</li>
</ul>
<p>Hoe weet je of je sanctum al hebt ge√Ønstalleerd?</p>
<ul>
<li>In composer.json staat een regel: &quot;laravel/sanctum&quot;: &quot;^2.xx&quot;,</li>
<li>In de map config is een bestand 'sanctum.php'</li>
<li>Er is een migration-file die zorgt voor een extra tabel met API tokens (personal_access_token)</li>
<li>In het User-model wordt gebruik gemaakt van de 'HasApiTokens'-trait</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">HasApiTokens</span><span class="token punctuation">;</span>
  <span class="token operator">...</span><span class="token operator">.</span></code></pre>
<h2 id="session-based-authenticatie-vs-token-bases-authenticatie.">Session based authenticatie vs token-bases authenticatie.</h2>
<p>Standaard Laravel applicaties die zijn gebaseerd op views met blade werken met cookies en sessies. Authenticatie en authorisatie gebeurd door een key te zetten als cookie en te associeren met data op de server (session-data).
Het voordeel van sessie-authenticatie is dat je gebruik kunt maken van csrf-tokens en dat je daarmee je app tegen xss-aanvallen beschermt.<br>
Sanctum zal proberen te werken met een sessies, maar als dat niet kan wordt de authenticatie op basis van het token gedaan.</p>
<h2 id="registreren">Registreren</h2>
<p>Om 'users' te registreren en in te kunnen loggen is het handig om een aparte controller te maken...</p>
<pre class="language-php"><code class="language-php">php artisan make<span class="token punctuation">:</span>controller AuthController</code></pre>
<p>Om een user te registreren zijn naam, email, password en een rol nodig. Op basis van de rol wordt bepaald wat de 'user' allemaal mag en kan (abilities).
In eerste instantie moet de data om de 'user' aan te maken gevalideerd worden. Dit kan weer met een formrequest.</p>
<pre class="language-php"><code class="language-php">php artisan make<span class="token punctuation">:</span>request StoreUserRequest</code></pre>
<p>Dit zijn de 'rules' waarmee de data wordt gecontroleerd...</p>
<pre class="language-php"><code class="language-php">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'name'</span> <span class="token operator">=></span><span class="token string single-quoted-string">'required|string'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'email'</span><span class="token operator">=></span><span class="token string single-quoted-string">'required|string|email|unique:users,email'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'password'</span> <span class="token operator">=></span><span class="token string single-quoted-string">'required|confirmed'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'role'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'required'</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>In de AuthController wordt een register-methode gedefinieerd, waarbij een user wordt aangemaakt in de database...</p>
<pre class="language-php"><code class="language-php">   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token class-name type-declaration">StoreUserRequest</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">email</span> <span class="token operator">=</span><span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">role</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token class-name static-context">Hash</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Met sanctum kun je zgn. abilities verwerken in een token. Bijvoorbeeld 'read', 'edit post', 'destroy user' etc. zijn 'abilities' die je kunt koppelen aan een rol. Je kunt de koppeling tussen rol en abilities natuurlijk opslaan in een database, in dit geval is er voor gekozen om een object te maken waarin de rollen en abilities zijn verwerkt.
Om gebruik te kunnen maken van 'abilities' moet je nog 2 classes toevoegen aan de variabele '$routeMiddleWare' in 'kernel.php':</p>
<pre class="language-php"><code class="language-php">    <span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span><span class="token operator">.</span>
        <span class="token string single-quoted-string">'abilities'</span> <span class="token operator">=></span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Laravel<span class="token punctuation">\</span>Sanctum<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>CheckAbilities</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'ability'</span> <span class="token operator">=></span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Laravel<span class="token punctuation">\</span>Sanctum<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>CheckForAnyAbility</span><span class="token operator">::</span><span class="token keyword">class</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>  </code></pre>
<p>Met de methode getAbilities wordt een array met abilities voor een bepaalde rol opgehaald.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Lib</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Abilities</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getAbilities</span><span class="token punctuation">(</span><span class="token variable">$role</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$abilities</span> <span class="token operator">=</span>  <span class="token punctuation">[</span>
          <span class="token string single-quoted-string">'admin'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'edit-any'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'create-movie'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'destroy-any'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'user'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'edit-own'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'create'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'editor'</span>  <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'edit-any'</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$role</span><span class="token punctuation">,</span> <span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$abilities</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$abilities</span><span class="token punctuation">[</span><span class="token variable">$role</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Sanctum kan op basis van het user-object een token genereren en opslaan in de database (personal_access_tokens-tabel). De abilities worden verwerkt in het token....</p>
<pre class="language-php"><code class="language-php">   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Abilities</span> <span class="token variable">$abilities</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">StoreUserRequest</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">email</span> <span class="token operator">=</span><span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">role</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token class-name static-context">Hash</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token variable">$tokenabilities</span> <span class="token operator">=</span> <span class="token variable">$abilities</span><span class="token operator">-></span><span class="token function">getAbilities</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token property">role</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">createToken</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test-app-token'</span><span class="token punctuation">,</span> <span class="token variable">$tokenabilities</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token property">plainTextToken</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'status'</span><span class="token operator">=></span><span class="token constant boolean">true</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'message'</span><span class="token operator">=></span><span class="token string single-quoted-string">'registered successfully!'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'data'</span> <span class="token operator">=></span><span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'user'</span><span class="token operator">=></span><span class="token variable">$user</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'token'</span><span class="token operator">=></span><span class="token variable">$token</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">,</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Om de authorisatie te laten werken kun je gebruik maken van de sanctum-middleware in de routes. Bijvoorbeeld om uit te loggen moet een gebruiker een token hebben. (Er zijn verder geen abilities vereist)</p>
<pre class="language-php"><code class="language-php"><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/logout"</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token class-name static-context">AuthController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'logout'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'auth:sanctum'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Niet iedereen mag movies aanmaken. Daarvoor is de ability 'create-movie' voor vereist...</p>
<pre class="language-php"><code class="language-php"><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/movies'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name static-context">MovieController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'store'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">-></span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'auth:sanctum'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'abilities:create-movie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
